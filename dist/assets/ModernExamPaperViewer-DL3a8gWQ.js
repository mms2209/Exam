import{c as X,x as W,u as Q,w as K,r as n,s as g,j as e,Y as ee,F as se,M as $,Z as te}from"./index-ClB3VN6O.js";import{L as F}from"./loader-2-wSKkewJn.js";import{S as ae}from"./send-C24Xy0Om.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=X("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);function ie(){const{paperId:o}=W(),{user:d}=Q(),p=K(),[i,U]=n.useState(null),[x,f]=n.useState([]),[h,w]=n.useState(""),[q,S]=n.useState(!0),[y,_]=n.useState(!1),[C,I]=n.useState(null),[u,k]=n.useState("both"),[b,j]=n.useState(!1),[A,D]=n.useState([]),M=n.useRef(null),G=n.useRef(null);n.useEffect(()=>{o&&d&&(L(),R(),E())},[o,d]),n.useEffect(()=>{J()},[x]);const J=()=>{var s;(s=M.current)==null||s.scrollIntoView({behavior:"smooth"})},L=async()=>{try{S(!0),I(null);const{data:s,error:a}=await g.from("exam_papers").select(`
          *,
          subject:exam_subjects(*)
        `).eq("id",o).single();if(a)throw a;s&&U({...s,subject:s.subject})}catch(s){console.error("Error fetching paper:",s),I(s.message||"Failed to load exam paper")}finally{S(!1)}},R=async()=>{if(!(!o||!d))try{const{data:s,error:a}=await g.from("chat_sessions").select("*").eq("paper_id",o).eq("user_id",d.id).maybeSingle();if(a&&a.code!=="PGRST116")throw a;s&&s.messages&&f(s.messages)}catch(s){console.error("Error fetching chat history:",s)}},E=async()=>{if(d)try{const{data:s,error:a}=await g.from("chat_sessions").select(`
          *,
          paper:exam_papers(*, subject:exam_subjects(*))
        `).eq("user_id",d.id).order("updated_at",{ascending:!1});if(a)throw a;D(s||[])}catch(s){console.error("Error fetching chat sessions:",s)}},T=async s=>{if(!(!o||!d))try{const{error:a}=await g.from("chat_sessions").upsert({user_id:d.id,paper_id:o,messages:s,updated_at:new Date().toISOString()},{onConflict:"user_id,paper_id"});if(a)throw a}catch(a){console.error("Error saving chat history:",a)}},Z=async s=>{if(s.preventDefault(),!h.trim()||y||!i)return;const a={id:crypto.randomUUID(),role:"user",content:h,timestamp:new Date().toISOString()},t=[...x,a];f(t),w(""),_(!0);try{const c=await fetch("https://cxdfcqjtdsfqfnejccto.supabase.co/functions/v1/exam-chat-ai",{method:"POST",headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4ZGZjcWp0ZHNmcWZuZWpjY3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODc2MjcsImV4cCI6MjA3NDg2MzYyN30.-0zSfIFij--VsNsSv5us9acCLeILTuPy6QO6D_RdX3Y","Content-Type":"application/json"},body:JSON.stringify({paperId:i.id,question:h,paperContent:i.paper_extracted_text,markingSchemeContent:i.marking_scheme_extracted_text})});if(!c.ok){const B=await c.json();throw new Error(B.error||"Failed to get AI response")}const Y=(await c.json()).message,P=[...t,Y];f(P),await T(P),await E()}catch(l){console.error("Error sending message:",l);const r={id:crypto.randomUUID(),role:"assistant",content:JSON.stringify({explanation:`Error: ${l.message||"Failed to get AI response. Please try again."}`,examples:[],howToGetFullMarks:[],solution:""}),timestamp:new Date().toISOString()},c=[...t,r];f(c)}finally{_(!1)}},z=s=>{const a="exam-papers",{data:t}=g.storage.from(a).getPublicUrl(s);return t.publicUrl},V=()=>{const s={};return A.forEach(a=>{var l,r;const t=((r=(l=a.paper)==null?void 0:l.subject)==null?void 0:r.name)||"Unknown";s[t]||(s[t]=[]),s[t].push(a)}),s};if(q)return e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gray-50",children:e.jsx(F,{className:"h-8 w-8 animate-spin text-emerald-600"})});if(C||!i)return e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen bg-gray-50",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-900 mb-2",children:"Error Loading Paper"}),e.jsx("p",{className:"text-gray-600 mb-4",children:C||"Paper not found"}),e.jsx("button",{onClick:()=>p("/home"),className:"px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors",children:"Back to Home"})]})});const N=V();let O=null;const v=x[x.length-1];if(v&&v.role==="assistant")try{O=JSON.parse(v.content)}catch{O=null}return e.jsxs("div",{className:"flex h-screen bg-gray-50",children:[e.jsxs("div",{className:`hidden lg:flex flex-col w-64 bg-white border-r border-gray-200 ${b?"flex":"hidden lg:flex"}`,children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("button",{onClick:()=>p("/home"),className:"flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 transition-colors",children:[e.jsx(H,{className:"h-4 w-4"}),"Home"]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsx("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:"Chat History"}),e.jsxs("div",{className:"space-y-4",children:[Object.entries(N).map(([s,a])=>e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-2",children:s}),e.jsx("div",{className:"space-y-1",children:a.map(t=>{var r,c,m;const l=t.paper_id===o;return e.jsxs("button",{onClick:()=>p(`/exam-paper/${t.paper_id}`),className:`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${l?"bg-emerald-50 text-emerald-700 font-medium":"text-gray-600 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"truncate",children:[(r=t.paper)==null?void 0:r.year," - Paper ",(c=t.paper)==null?void 0:c.paper_number]}),e.jsxs("div",{className:"text-xs text-gray-500 truncate",children:["Grade ",((m=t.paper)==null?void 0:m.grade_level)||"12"]})]},t.id)})})]},s)),Object.keys(N).length===0&&e.jsx("div",{className:"text-sm text-gray-500 text-center py-4",children:"No chat history yet"})]})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>j(!b),className:"lg:hidden p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(ee,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-lg font-semibold text-gray-900",children:[i.subject.name," - Grade ",i.grade_level||"12"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[i.year," Paper ",i.paper_number,i.title&&` - ${i.title}`]})]})]}),e.jsxs("div",{className:"flex lg:hidden gap-2",children:[e.jsx("button",{onClick:()=>k("paper"),className:`p-2 rounded-lg transition-colors ${u==="paper"?"bg-emerald-100 text-emerald-700":"text-gray-600 hover:bg-gray-100"}`,children:e.jsx(se,{className:"h-5 w-5"})}),e.jsx("button",{onClick:()=>k("chat"),className:`p-2 rounded-lg transition-colors ${u==="chat"?"bg-emerald-100 text-emerald-700":"text-gray-600 hover:bg-gray-100"}`,children:e.jsx($,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:`flex-1 bg-gray-100 ${u==="chat"?"hidden lg:flex":"flex"} ${u==="both"?"lg:flex":""}`,children:e.jsx("iframe",{ref:G,src:z(i.paper_file_url),className:"w-full h-full border-0",title:"Exam Paper PDF"})}),e.jsxs("div",{className:`w-full lg:w-[500px] flex flex-col bg-white border-l border-gray-200 ${u==="paper"?"hidden lg:flex":"flex"}`,children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[x.length===0?e.jsxs("div",{className:"text-center text-gray-500 mt-8",children:[e.jsx($,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"Ask a question about this exam paper"}),e.jsx("p",{className:"text-xs mt-1",children:'Example: "Explain question 1"'})]}):x.map(s=>{const a=s.role==="user";let t=null;if(!a)try{t=JSON.parse(s.content)}catch{t=null}return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[85%] rounded-2xl px-4 py-3 ${a?"bg-emerald-600 text-white":"bg-gray-100 text-gray-900"}`,children:a?e.jsx("p",{className:"text-sm",children:s.content}):t?e.jsxs("div",{className:"space-y-3 text-sm",children:[t.explanation&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"Explanation"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-wrap font-mono text-xs leading-relaxed",children:t.explanation})]}),t.examples&&t.examples.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"Examples"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-gray-700",children:t.examples.map((l,r)=>e.jsx("li",{className:"text-xs",children:l},r))})]}),t.howToGetFullMarks&&t.howToGetFullMarks.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"How to Get Full Marks"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-gray-700",children:t.howToGetFullMarks.map((l,r)=>e.jsx("li",{className:"text-xs",children:l},r))})]}),t.solution&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"Solution"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-wrap font-mono text-xs leading-relaxed",children:t.solution})]})]}):e.jsx("p",{className:"text-sm",children:s.content})})},s.id)}),y&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 rounded-2xl px-4 py-3",children:e.jsx(F,{className:"h-5 w-5 animate-spin text-gray-600"})})}),e.jsx("div",{ref:M})]}),e.jsx("div",{className:"border-t border-gray-200 p-4",children:e.jsxs("form",{onSubmit:Z,className:"flex gap-2",children:[e.jsx("input",{type:"text",value:h,onChange:s=>w(s.target.value),placeholder:"Ask about a question...",className:"flex-1 border border-gray-300 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent",disabled:y}),e.jsx("button",{type:"submit",disabled:!h.trim()||y,className:"p-2.5 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(ae,{className:"h-5 w-5"})})]})})]})]})]}),b&&e.jsx("div",{className:"lg:hidden fixed inset-0 z-50 bg-black bg-opacity-50",onClick:()=>j(!1),children:e.jsxs("div",{className:"absolute left-0 top-0 bottom-0 w-64 bg-white",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>p("/home"),className:"flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 transition-colors",children:[e.jsx(H,{className:"h-4 w-4"}),"Home"]}),e.jsx("button",{onClick:()=>j(!1),className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(te,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"overflow-y-auto p-4",style:{maxHeight:"calc(100vh - 73px)"},children:[e.jsx("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:"Chat History"}),e.jsx("div",{className:"space-y-4",children:Object.entries(N).map(([s,a])=>e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-2",children:s}),e.jsx("div",{className:"space-y-1",children:a.map(t=>{var r,c,m;const l=t.paper_id===o;return e.jsxs("button",{onClick:()=>{p(`/exam-paper/${t.paper_id}`),j(!1)},className:`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${l?"bg-emerald-50 text-emerald-700 font-medium":"text-gray-600 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"truncate",children:[(r=t.paper)==null?void 0:r.year," - Paper ",(c=t.paper)==null?void 0:c.paper_number]}),e.jsxs("div",{className:"text-xs text-gray-500 truncate",children:["Grade ",((m=t.paper)==null?void 0:m.grade_level)||"12"]})]},t.id)})})]},s))})]})]})})]})}export{ie as default};
