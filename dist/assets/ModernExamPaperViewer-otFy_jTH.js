import{c as se,x as te,u as re,w as ae,r as i,s as x,j as e,Y as C,Z as le,F as E,M as A,_ as ne}from"./index-D0GkCXRG.js";import{L as I}from"./loader-2-Vt8px6dZ.js";import{S as ie}from"./send-BYUh2PAu.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=se("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);function xe(){const{paperId:d}=te(),{user:c}=re(),h=ae(),[o,J]=i.useState(null),[P,T]=i.useState(""),[m,f]=i.useState([]),[g,F]=i.useState(""),[M,U]=i.useState(!0),[y,L]=i.useState(!1),[j,N]=i.useState(null),[u,O]=i.useState("both"),[v,b]=i.useState(!1),[Z,w]=i.useState([]),R=i.useRef(null),z=i.useRef(null),S=i.useRef(!1);i.useEffect(()=>{d&&(c!=null&&c.id)&&!S.current&&(S.current=!0,Y(),B(),$())},[d,c==null?void 0:c.id]),i.useEffect(()=>()=>{S.current=!1},[d]),i.useEffect(()=>{V()},[m]);const V=()=>{var s;(s=R.current)==null||s.scrollIntoView({behavior:"smooth"})},Y=async()=>{try{U(!0),N(null);const{data:s,error:r}=await x.from("exam_papers").select(`
          *,
          subject:exam_subjects(*)
        `).eq("id",d).maybeSingle();if(r)throw r;if(!s)throw new Error("Paper not found");if(s){J({...s,subject:s.subject}),console.log("📄 Paper file URL:",s.paper_file_url);const t=await D(s.paper_file_url);console.log("🔗 Generated signed URL:",t),t?T(t):(console.error("❌ Failed to generate signed URL"),N("Failed to load PDF file"))}}catch(s){console.error("Error fetching paper:",s),N(s.message||"Failed to load exam paper")}finally{U(!1)}},B=async()=>{if(!(!d||!c))try{const{data:s,error:r}=await x.from("chat_sessions").select("*").eq("paper_id",d).eq("user_id",c.id).maybeSingle();if(r&&r.code!=="PGRST116")throw r;s&&s.messages&&f(s.messages)}catch(s){console.error("Error fetching chat history:",s)}},$=async()=>{if(c)try{const{data:s,error:r}=await x.from("chat_sessions").select("*").eq("user_id",c.id).order("updated_at",{ascending:!1});if(r)throw r;if(!s){w([]);return}const t=await Promise.all(s.map(async a=>{const{data:l,error:n}=await x.from("exam_papers").select(`
              *,
              subject:exam_subjects(*)
            `).eq("id",a.paper_id).maybeSingle();return n?(console.error("Error fetching paper:",n),{...a,paper:null}):{...a,paper:l}}));w(t)}catch(s){console.error("Error fetching chat sessions:",s),w([])}},X=async s=>{if(!(!d||!c))try{const{error:r}=await x.from("chat_sessions").upsert({user_id:c.id,paper_id:d,messages:s,updated_at:new Date().toISOString()},{onConflict:"user_id,paper_id"});if(r)throw r}catch(r){console.error("Error saving chat history:",r)}},W=async s=>{if(s.preventDefault(),!g.trim()||y||!o)return;const r={id:crypto.randomUUID(),role:"user",content:g,timestamp:new Date().toISOString()},t=[...m,r];f(t),F(""),L(!0);try{const n=await fetch("https://cxdfcqjtdsfqfnejccto.supabase.co/functions/v1/exam-chat-ai",{method:"POST",headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4ZGZjcWp0ZHNmcWZuZWpjY3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODc2MjcsImV4cCI6MjA3NDg2MzYyN30.-0zSfIFij--VsNsSv5us9acCLeILTuPy6QO6D_RdX3Y","Content-Type":"application/json"},body:JSON.stringify({paperId:o.id,question:g,paperContent:o.paper_extracted_text,markingSchemeContent:o.marking_scheme_extracted_text})});if(!n.ok){const ee=await n.json();throw new Error(ee.error||"Failed to get AI response")}const K=(await n.json()).message,q=[...t,K];f(q),await X(q),await $()}catch(a){console.error("Error sending message:",a);const l={id:crypto.randomUUID(),role:"assistant",content:JSON.stringify({explanation:`Error: ${a.message||"Failed to get AI response. Please try again."}`,examples:[],howToGetFullMarks:[],solution:""}),timestamp:new Date().toISOString()},n=[...t,l];f(n)}finally{L(!1)}},D=async s=>{try{const r="exam-papers";console.log("🔍 Attempting to create signed URL for:",s,"in bucket:",r);const{data:t,error:a}=await x.storage.from(r).createSignedUrl(s,3600);if(a){console.error("❌ Error creating signed URL:",a),console.error("❌ Error details:",JSON.stringify(a,null,2));const{data:l,error:n}=await x.storage.from(r).list();return n?console.error("❌ Cannot list files in bucket:",n):console.log("📁 Files in bucket:",l),""}return t!=null&&t.signedUrl?(console.log("✅ Successfully created signed URL"),t.signedUrl):(console.error("❌ No signed URL returned"),"")}catch(r){return console.error("❌ Exception in getPaperUrl:",r),""}},Q=()=>{const s={};return Z.forEach(r=>{var a,l;const t=((l=(a=r.paper)==null?void 0:a.subject)==null?void 0:l.name)||"Unknown";s[t]||(s[t]=[]),s[t].push(r)}),s};if(M)return e.jsxs(e.Fragment,{children:[e.jsx(C,{}),e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gray-50",children:e.jsx(I,{className:"h-8 w-8 animate-spin text-emerald-600"})})]});if(j||!o)return e.jsxs(e.Fragment,{children:[e.jsx(C,{}),e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen bg-gray-50",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-900 mb-2",children:"Error Loading Paper"}),e.jsx("p",{className:"text-gray-600 mb-4",children:j||"Paper not found"}),e.jsx("button",{onClick:()=>h("/home"),className:"px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors",children:"Back to Home"})]})})]});const _=Q();let H=null;const k=m[m.length-1];if(k&&k.role==="assistant")try{H=JSON.parse(k.content)}catch{H=null}return e.jsxs(e.Fragment,{children:[e.jsx(C,{}),e.jsxs("div",{className:"flex bg-gray-50",style:{height:"calc(100vh - 64px)"},children:[e.jsxs("div",{className:`hidden lg:flex flex-col w-64 bg-white border-r border-gray-200 ${v?"flex":"hidden lg:flex"}`,children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("button",{onClick:()=>h("/home"),className:"flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 transition-colors",children:[e.jsx(G,{className:"h-4 w-4"}),"Home"]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsx("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:"Chat History"}),e.jsxs("div",{className:"space-y-4",children:[Object.entries(_).map(([s,r])=>e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-2",children:s}),e.jsx("div",{className:"space-y-1",children:r.map(t=>{var l,n,p;const a=t.paper_id===d;return e.jsxs("button",{onClick:()=>h(`/exam-paper/${t.paper_id}`),className:`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${a?"bg-emerald-50 text-emerald-700 font-medium":"text-gray-600 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"truncate",children:[(l=t.paper)==null?void 0:l.year," - Paper ",(n=t.paper)==null?void 0:n.paper_number]}),e.jsxs("div",{className:"text-xs text-gray-500 truncate",children:["Grade ",((p=t.paper)==null?void 0:p.grade_level)||"12"]})]},t.id)})})]},s)),Object.keys(_).length===0&&e.jsx("div",{className:"text-sm text-gray-500 text-center py-4",children:"No chat history yet"})]})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>b(!v),className:"lg:hidden p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(le,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-lg font-semibold text-gray-900",children:[o.subject.name," - Grade ",o.grade_level||"12"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[o.year," Paper ",o.paper_number,o.title&&` - ${o.title}`]})]})]}),e.jsxs("div",{className:"flex lg:hidden gap-2",children:[e.jsx("button",{onClick:()=>O("paper"),className:`p-2 rounded-lg transition-colors ${u==="paper"?"bg-emerald-100 text-emerald-700":"text-gray-600 hover:bg-gray-100"}`,children:e.jsx(E,{className:"h-5 w-5"})}),e.jsx("button",{onClick:()=>O("chat"),className:`p-2 rounded-lg transition-colors ${u==="chat"?"bg-emerald-100 text-emerald-700":"text-gray-600 hover:bg-gray-100"}`,children:e.jsx(A,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:`flex-1 bg-gray-100 ${u==="chat"?"hidden lg:flex":"flex"} ${u==="both"?"lg:flex":""}`,children:P?e.jsx("iframe",{ref:z,src:`${P}#view=FitH`,className:"w-full h-full border-0",title:"Exam Paper PDF",onLoad:()=>console.log("✅ PDF iframe loaded"),onError:s=>{console.error("❌ PDF iframe error:",s)}}):M?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(I,{className:"h-8 w-8 animate-spin text-emerald-600"})}):j?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center",children:[e.jsx(E,{className:"h-16 w-16 text-red-400 mb-4"}),e.jsx("p",{className:"text-red-600 mb-4",children:j}),(o==null?void 0:o.paper_file_url)&&e.jsx("button",{onClick:async()=>{const s=await D(o.paper_file_url);s&&window.open(s,"_blank")},className:"px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors",children:"Open PDF in New Tab"})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center",children:[e.jsx(E,{className:"h-16 w-16 text-gray-400 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"No PDF available"})]})}),e.jsxs("div",{className:`w-full lg:w-[500px] flex flex-col bg-white border-l border-gray-200 ${u==="paper"?"hidden lg:flex":"flex"}`,children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[m.length===0?e.jsxs("div",{className:"text-center text-gray-500 mt-8",children:[e.jsx(A,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"Ask a question about this exam paper"}),e.jsx("p",{className:"text-xs mt-1",children:'Example: "Explain question 1"'})]}):m.map(s=>{const r=s.role==="user";let t=null;if(!r)try{t=JSON.parse(s.content)}catch{t=null}return e.jsx("div",{className:`flex ${r?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[85%] rounded-2xl px-4 py-3 ${r?"bg-emerald-600 text-white":"bg-gray-100 text-gray-900"}`,children:r?e.jsx("p",{className:"text-sm",children:s.content}):t?e.jsxs("div",{className:"space-y-3 text-sm",children:[t.explanation&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"Explanation"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-wrap font-mono text-xs leading-relaxed",children:t.explanation})]}),t.examples&&t.examples.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"Examples"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-gray-700",children:t.examples.map((a,l)=>e.jsx("li",{className:"text-xs",children:a},l))})]}),t.howToGetFullMarks&&t.howToGetFullMarks.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"How to Get Full Marks"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-gray-700",children:t.howToGetFullMarks.map((a,l)=>e.jsx("li",{className:"text-xs",children:a},l))})]}),t.solution&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"Solution"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-wrap font-mono text-xs leading-relaxed",children:t.solution})]})]}):e.jsx("p",{className:"text-sm",children:s.content})})},s.id)}),y&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 rounded-2xl px-4 py-3",children:e.jsx(I,{className:"h-5 w-5 animate-spin text-gray-600"})})}),e.jsx("div",{ref:R})]}),e.jsx("div",{className:"border-t border-gray-200 p-4",children:e.jsxs("form",{onSubmit:W,className:"flex gap-2",children:[e.jsx("input",{type:"text",value:g,onChange:s=>F(s.target.value),placeholder:"Ask about a question...",className:"flex-1 border border-gray-300 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent",disabled:y}),e.jsx("button",{type:"submit",disabled:!g.trim()||y,className:"p-2.5 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(ie,{className:"h-5 w-5"})})]})})]})]})]}),v&&e.jsx("div",{className:"lg:hidden fixed inset-0 z-50 bg-black bg-opacity-50",onClick:()=>b(!1),children:e.jsxs("div",{className:"absolute left-0 top-0 bottom-0 w-64 bg-white",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>h("/home"),className:"flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 transition-colors",children:[e.jsx(G,{className:"h-4 w-4"}),"Home"]}),e.jsx("button",{onClick:()=>b(!1),className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(ne,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"overflow-y-auto p-4",style:{maxHeight:"calc(100vh - 73px)"},children:[e.jsx("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:"Chat History"}),e.jsx("div",{className:"space-y-4",children:Object.entries(_).map(([s,r])=>e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-2",children:s}),e.jsx("div",{className:"space-y-1",children:r.map(t=>{var l,n,p;const a=t.paper_id===d;return e.jsxs("button",{onClick:()=>{h(`/exam-papers/${t.paper_id}`),b(!1)},className:`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${a?"bg-emerald-50 text-emerald-700 font-medium":"text-gray-600 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"truncate",children:[(l=t.paper)==null?void 0:l.year," - Paper ",(n=t.paper)==null?void 0:n.paper_number]}),e.jsxs("div",{className:"text-xs text-gray-500 truncate",children:["Grade ",((p=t.paper)==null?void 0:p.grade_level)||"12"]})]},t.id)})})]},s))})]})]})})]})]})}export{xe as default};
