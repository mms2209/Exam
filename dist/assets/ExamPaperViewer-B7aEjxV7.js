import{c as y,w as T,v as U,r as d,t as c,j as e,F as $,M as S,A as D}from"./index-Dq_GmYNv.js";import{u as P}from"./useQuery-DFabVRPe.js";import{u as _}from"./useMutation-Dt4-YrWq.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=y("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const f=y("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=y("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);function K(){var k;const{paperId:r}=T(),E=U(),[j,I]=d.useState(null),[u,b]=d.useState([]),[x,N]=d.useState(""),[A,v]=d.useState(null),[w,h]=d.useState(null),{data:t,isLoading:C}=P({queryKey:["exam-paper",r],queryFn:()=>c.getExamPaperById(r),enabled:!!r}),{data:p}=P({queryKey:["chat-session",r],queryFn:()=>c.getChatSession(r),enabled:!!r});d.useEffect(()=>{p&&(v(p.id),b(p.messages||[]))},[p]),d.useEffect(()=>{t&&(c.trackPaperAccess(t.id),c.getPaperFileUrl(t.paper_file_url).then(s=>{s&&I(s)}))},[t]);const o=_({mutationFn:async s=>{const a={id:crypto.randomUUID(),role:"user",content:s,timestamp:new Date().toISOString()};h(null);const i=t?`
Exam Paper: ${t.title||"Untitled"}
Year: ${t.year}
Paper Number: ${t.paper_number}
Subject ID: ${t.subject_id}

This is an exam paper that students are studying. The student is asking about a specific question from this paper.
`:"No paper context available",l=await c.sendChatMessage({paperId:r,question:s,paperContent:i,markingSchemeContent:`
The marking scheme for this exam paper is available but PDF text extraction is not yet implemented.
Please provide your best educational guidance based on the question asked and general exam principles.
`});return{userMessage:a,response:l}},onSuccess:async s=>{const{userMessage:a,response:i}=s,n=i.message;b(m=>{const M=new Set(m.map(L=>L.id)),g=[];return M.has(a.id)||g.push(a),M.has(n.id)||g.push(n),[...m,...g]});let l=A;if(!l&&r&&(l=(await c.createChatSession(r)).id,v(l)),l){const m=[...u,a,n];await c.updateChatSession(l,m)}},onError:s=>{let a="Unable to get a response from the AI tutor. Please try again.";s.status===503?a="AI service is currently unavailable. Please contact your administrator to configure the service.":s.status===429?a="AI service quota exceeded. Please try again later.":s.message&&(a=s.message),h(a)}}),q=s=>{s.preventDefault(),x.trim()&&!o.isPending&&(o.mutate(x),N(""))},F=s=>{try{return JSON.parse(s)}catch{return null}};return C?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(f,{className:"h-8 w-8 animate-spin text-emerald-600"})}):t?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>E("/app/exam-papers"),className:"inline-flex items-center text-sm text-gray-600 hover:text-gray-900",children:[e.jsx(G,{className:"h-4 w-4 mr-1"}),"Back to Papers"]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h1",{className:"text-xl font-bold text-gray-900",children:[(k=t.subject)==null?void 0:k.name," - Paper ",t.paper_number," (",t.year,")"]}),t.title&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:t.title})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 h-[calc(100vh-250px)]",children:[e.jsxs("div",{className:"bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center",children:[e.jsx($,{className:"h-5 w-5 text-gray-600 mr-2"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Exam Paper"})]}),e.jsx("div",{className:"h-full overflow-auto p-4",children:j?e.jsx("iframe",{src:j,className:"w-full h-full border-0",title:"Exam Paper"}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(f,{className:"h-8 w-8 animate-spin text-gray-400"})})})]}),e.jsxs("div",{className:"bg-white shadow-sm rounded-lg border border-gray-200 flex flex-col",children:[e.jsxs("div",{className:"bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center",children:[e.jsx(S,{className:"h-5 w-5 text-gray-600 mr-2"}),e.jsx("span",{className:"font-medium text-gray-900",children:"AI Tutor"})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 space-y-4",children:[w&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(D,{className:"h-5 w-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-red-800 font-medium",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:w})]}),e.jsx("button",{onClick:()=>h(null),className:"text-red-400 hover:text-red-600",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),u.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(S,{className:"h-12 w-12 mx-auto mb-3 text-gray-400"}),e.jsx("p",{className:"text-sm mb-2",children:"Ask the AI tutor about any question!"}),e.jsx("p",{className:"text-xs text-gray-400",children:'Example: "Explain question 5" or "How do I solve question 3?"'})]}):u.map(s=>{const a=s.role==="assistant"?F(s.content):null;return e.jsx("div",{className:`flex ${s.role==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[85%] rounded-lg px-4 py-3 ${s.role==="user"?"bg-emerald-600 text-white":"bg-gray-100 text-gray-900"}`,children:s.role==="user"?e.jsx("p",{className:"text-sm",children:s.content}):a?e.jsxs("div",{className:"space-y-3 text-sm",children:[a.explanation&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Explanation"}),e.jsx("p",{className:"text-gray-700",children:a.explanation})]}),a.examples&&a.examples.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Examples"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-gray-700",children:a.examples.map((i,n)=>e.jsx("li",{children:i},n))})]}),a.howToGetFullMarks&&a.howToGetFullMarks.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1",children:"How to Get Full Marks"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-gray-700",children:a.howToGetFullMarks.map((i,n)=>e.jsx("li",{children:i},n))})]}),a.solution&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Solution"}),e.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:a.solution})]})]}):e.jsx("p",{className:"text-sm",children:s.content})})},s.id)}),o.isPending&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 rounded-lg px-4 py-3",children:e.jsx(f,{className:"h-5 w-5 animate-spin text-gray-600"})})})]}),e.jsx("div",{className:"border-t border-gray-200 p-4",children:e.jsxs("form",{onSubmit:q,className:"flex gap-2",children:[e.jsx("input",{type:"text",value:x,onChange:s=>N(s.target.value),placeholder:"Ask about a specific question...",className:"flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500",disabled:o.isPending}),e.jsx("button",{type:"submit",disabled:!x.trim()||o.isPending,className:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(z,{className:"h-4 w-4"})})]})})]})]})]}):e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-gray-600",children:"Exam paper not found"})})}export{K as ExamPaperViewer};
