import{c as Q,x as K,u as ee,w as se,r as n,s as p,j as e,Y as _,Z as te,F as ae,M as q,_ as re}from"./index-CZZYYvlE.js";import{L as H}from"./loader-2-BS6YuLYP.js";import{S as le}from"./send-icVutfLJ.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=Q("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);function oe(){const{paperId:d}=K(),{user:c}=ee(),h=se(),[o,A]=n.useState(null),[x,f]=n.useState([]),[u,C]=n.useState(""),[D,I]=n.useState(!0),[y,k]=n.useState(!1),[E,M]=n.useState(null),[g,P]=n.useState("both"),[b,j]=n.useState(!1),[G,N]=n.useState([]),F=n.useRef(null),J=n.useRef(null),v=n.useRef(!1);n.useEffect(()=>{d&&(c!=null&&c.id)&&!v.current&&(v.current=!0,T(),Z(),O())},[d,c==null?void 0:c.id]),n.useEffect(()=>()=>{v.current=!1},[d]),n.useEffect(()=>{L()},[x]);const L=()=>{var s;(s=F.current)==null||s.scrollIntoView({behavior:"smooth"})},T=async()=>{try{I(!0),M(null);const{data:s,error:a}=await p.from("exam_papers").select(`
          *,
          subject:exam_subjects(*)
        `).eq("id",d).maybeSingle();if(a)throw a;if(!s)throw new Error("Paper not found");s&&A({...s,subject:s.subject})}catch(s){console.error("Error fetching paper:",s),M(s.message||"Failed to load exam paper")}finally{I(!1)}},Z=async()=>{if(!(!d||!c))try{const{data:s,error:a}=await p.from("chat_sessions").select("*").eq("paper_id",d).eq("user_id",c.id).maybeSingle();if(a&&a.code!=="PGRST116")throw a;s&&s.messages&&f(s.messages)}catch(s){console.error("Error fetching chat history:",s)}},O=async()=>{if(c)try{const{data:s,error:a}=await p.from("chat_sessions").select("*").eq("user_id",c.id).order("updated_at",{ascending:!1});if(a)throw a;if(!s){N([]);return}const t=await Promise.all(s.map(async r=>{const{data:l,error:i}=await p.from("exam_papers").select(`
              *,
              subject:exam_subjects(*)
            `).eq("id",r.paper_id).maybeSingle();return i?(console.error("Error fetching paper:",i),{...r,paper:null}):{...r,paper:l}}));N(t)}catch(s){console.error("Error fetching chat sessions:",s),N([])}},z=async s=>{if(!(!d||!c))try{const{error:a}=await p.from("chat_sessions").upsert({user_id:c.id,paper_id:d,messages:s,updated_at:new Date().toISOString()},{onConflict:"user_id,paper_id"});if(a)throw a}catch(a){console.error("Error saving chat history:",a)}},V=async s=>{if(s.preventDefault(),!u.trim()||y||!o)return;const a={id:crypto.randomUUID(),role:"user",content:u,timestamp:new Date().toISOString()},t=[...x,a];f(t),C(""),k(!0);try{const i=await fetch("https://cxdfcqjtdsfqfnejccto.supabase.co/functions/v1/exam-chat-ai",{method:"POST",headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4ZGZjcWp0ZHNmcWZuZWpjY3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODc2MjcsImV4cCI6MjA3NDg2MzYyN30.-0zSfIFij--VsNsSv5us9acCLeILTuPy6QO6D_RdX3Y","Content-Type":"application/json"},body:JSON.stringify({paperId:o.id,question:u,paperContent:o.paper_extracted_text,markingSchemeContent:o.marking_scheme_extracted_text})});if(!i.ok){const W=await i.json();throw new Error(W.error||"Failed to get AI response")}const X=(await i.json()).message,R=[...t,X];f(R),await z(R),await O()}catch(r){console.error("Error sending message:",r);const l={id:crypto.randomUUID(),role:"assistant",content:JSON.stringify({explanation:`Error: ${r.message||"Failed to get AI response. Please try again."}`,examples:[],howToGetFullMarks:[],solution:""}),timestamp:new Date().toISOString()},i=[...t,l];f(i)}finally{k(!1)}},Y=s=>{const a="exam-papers",{data:t}=p.storage.from(a).getPublicUrl(s);return t.publicUrl},B=()=>{const s={};return G.forEach(a=>{var r,l;const t=((l=(r=a.paper)==null?void 0:r.subject)==null?void 0:l.name)||"Unknown";s[t]||(s[t]=[]),s[t].push(a)}),s};if(D)return e.jsxs(e.Fragment,{children:[e.jsx(_,{}),e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gray-50",children:e.jsx(H,{className:"h-8 w-8 animate-spin text-emerald-600"})})]});if(E||!o)return e.jsxs(e.Fragment,{children:[e.jsx(_,{}),e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen bg-gray-50",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("h2",{className:"text-2xl font-semibold text-gray-900 mb-2",children:"Error Loading Paper"}),e.jsx("p",{className:"text-gray-600 mb-4",children:E||"Paper not found"}),e.jsx("button",{onClick:()=>h("/home"),className:"px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors",children:"Back to Home"})]})})]});const w=B();let $=null;const S=x[x.length-1];if(S&&S.role==="assistant")try{$=JSON.parse(S.content)}catch{$=null}return e.jsxs(e.Fragment,{children:[e.jsx(_,{}),e.jsxs("div",{className:"flex bg-gray-50",style:{height:"calc(100vh - 64px)"},children:[e.jsxs("div",{className:`hidden lg:flex flex-col w-64 bg-white border-r border-gray-200 ${b?"flex":"hidden lg:flex"}`,children:[e.jsx("div",{className:"p-4 border-b border-gray-200",children:e.jsxs("button",{onClick:()=>h("/home"),className:"flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 transition-colors",children:[e.jsx(U,{className:"h-4 w-4"}),"Home"]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsx("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:"Chat History"}),e.jsxs("div",{className:"space-y-4",children:[Object.entries(w).map(([s,a])=>e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-2",children:s}),e.jsx("div",{className:"space-y-1",children:a.map(t=>{var l,i,m;const r=t.paper_id===d;return e.jsxs("button",{onClick:()=>h(`/exam-paper/${t.paper_id}`),className:`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${r?"bg-emerald-50 text-emerald-700 font-medium":"text-gray-600 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"truncate",children:[(l=t.paper)==null?void 0:l.year," - Paper ",(i=t.paper)==null?void 0:i.paper_number]}),e.jsxs("div",{className:"text-xs text-gray-500 truncate",children:["Grade ",((m=t.paper)==null?void 0:m.grade_level)||"12"]})]},t.id)})})]},s)),Object.keys(w).length===0&&e.jsx("div",{className:"text-sm text-gray-500 text-center py-4",children:"No chat history yet"})]})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>j(!b),className:"lg:hidden p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(te,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-lg font-semibold text-gray-900",children:[o.subject.name," - Grade ",o.grade_level||"12"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[o.year," Paper ",o.paper_number,o.title&&` - ${o.title}`]})]})]}),e.jsxs("div",{className:"flex lg:hidden gap-2",children:[e.jsx("button",{onClick:()=>P("paper"),className:`p-2 rounded-lg transition-colors ${g==="paper"?"bg-emerald-100 text-emerald-700":"text-gray-600 hover:bg-gray-100"}`,children:e.jsx(ae,{className:"h-5 w-5"})}),e.jsx("button",{onClick:()=>P("chat"),className:`p-2 rounded-lg transition-colors ${g==="chat"?"bg-emerald-100 text-emerald-700":"text-gray-600 hover:bg-gray-100"}`,children:e.jsx(q,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:`flex-1 bg-gray-100 ${g==="chat"?"hidden lg:flex":"flex"} ${g==="both"?"lg:flex":""}`,children:e.jsx("iframe",{ref:J,src:Y(o.paper_file_url),className:"w-full h-full border-0",title:"Exam Paper PDF"})}),e.jsxs("div",{className:`w-full lg:w-[500px] flex flex-col bg-white border-l border-gray-200 ${g==="paper"?"hidden lg:flex":"flex"}`,children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[x.length===0?e.jsxs("div",{className:"text-center text-gray-500 mt-8",children:[e.jsx(q,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm",children:"Ask a question about this exam paper"}),e.jsx("p",{className:"text-xs mt-1",children:'Example: "Explain question 1"'})]}):x.map(s=>{const a=s.role==="user";let t=null;if(!a)try{t=JSON.parse(s.content)}catch{t=null}return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[85%] rounded-2xl px-4 py-3 ${a?"bg-emerald-600 text-white":"bg-gray-100 text-gray-900"}`,children:a?e.jsx("p",{className:"text-sm",children:s.content}):t?e.jsxs("div",{className:"space-y-3 text-sm",children:[t.explanation&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"Explanation"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-wrap font-mono text-xs leading-relaxed",children:t.explanation})]}),t.examples&&t.examples.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"Examples"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-gray-700",children:t.examples.map((r,l)=>e.jsx("li",{className:"text-xs",children:r},l))})]}),t.howToGetFullMarks&&t.howToGetFullMarks.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"How to Get Full Marks"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-gray-700",children:t.howToGetFullMarks.map((r,l)=>e.jsx("li",{className:"text-xs",children:r},l))})]}),t.solution&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1.5 text-gray-900",children:"Solution"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-wrap font-mono text-xs leading-relaxed",children:t.solution})]})]}):e.jsx("p",{className:"text-sm",children:s.content})})},s.id)}),y&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 rounded-2xl px-4 py-3",children:e.jsx(H,{className:"h-5 w-5 animate-spin text-gray-600"})})}),e.jsx("div",{ref:F})]}),e.jsx("div",{className:"border-t border-gray-200 p-4",children:e.jsxs("form",{onSubmit:V,className:"flex gap-2",children:[e.jsx("input",{type:"text",value:u,onChange:s=>C(s.target.value),placeholder:"Ask about a question...",className:"flex-1 border border-gray-300 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent",disabled:y}),e.jsx("button",{type:"submit",disabled:!u.trim()||y,className:"p-2.5 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:e.jsx(le,{className:"h-5 w-5"})})]})})]})]})]}),b&&e.jsx("div",{className:"lg:hidden fixed inset-0 z-50 bg-black bg-opacity-50",onClick:()=>j(!1),children:e.jsxs("div",{className:"absolute left-0 top-0 bottom-0 w-64 bg-white",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("button",{onClick:()=>h("/home"),className:"flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 transition-colors",children:[e.jsx(U,{className:"h-4 w-4"}),"Home"]}),e.jsx("button",{onClick:()=>j(!1),className:"p-1 hover:bg-gray-100 rounded",children:e.jsx(re,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"overflow-y-auto p-4",style:{maxHeight:"calc(100vh - 73px)"},children:[e.jsx("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3",children:"Chat History"}),e.jsx("div",{className:"space-y-4",children:Object.entries(w).map(([s,a])=>e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-2",children:s}),e.jsx("div",{className:"space-y-1",children:a.map(t=>{var l,i,m;const r=t.paper_id===d;return e.jsxs("button",{onClick:()=>{h(`/exam-papers/${t.paper_id}`),j(!1)},className:`w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${r?"bg-emerald-50 text-emerald-700 font-medium":"text-gray-600 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"truncate",children:[(l=t.paper)==null?void 0:l.year," - Paper ",(i=t.paper)==null?void 0:i.paper_number]}),e.jsxs("div",{className:"text-xs text-gray-500 truncate",children:["Grade ",((m=t.paper)==null?void 0:m.grade_level)||"12"]})]},t.id)})})]},s))})]})]})})]})]})}export{oe as default};
