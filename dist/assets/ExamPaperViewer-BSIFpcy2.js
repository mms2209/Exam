import{c as U,x as L,w as q,r as d,t as c,j as e,F as V,M as S,A as b}from"./index-D9Q0vEE4.js";import{u as I}from"./useQuery-CMU2BuCx.js";import{u as G}from"./useMutation-D-AV7XrV.js";import{L as N}from"./loader-2-C_AzU_ya.js";import{S as z}from"./send-0jvgjYQ4.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=U("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);function X(){var E;const{paperId:l}=L(),C=q(),[y,F]=d.useState(null),[f,v]=d.useState([]),[u,w]=d.useState(""),[$,P]=d.useState(null),[_,j]=d.useState(null),{data:a,isLoading:T}=I({queryKey:["exam-papers",l],queryFn:()=>c.getExamPaperById(l),enabled:!!l}),{data:h}=I({queryKey:["chat-session",l],queryFn:()=>c.getChatSession(l),enabled:!!l});d.useEffect(()=>{h&&(P(h.id),v(h.messages||[]))},[h]),d.useEffect(()=>{a&&(c.trackPaperAccess(a.id),c.getPaperFileUrl(a.paper_file_url).then(s=>{s&&F(s)}))},[a]);const m=G({mutationFn:async s=>{var p,x,g,M,k,A;const r={id:crypto.randomUUID(),role:"user",content:s,timestamp:new Date().toISOString()};j(null);const t=await c.getExamPaperWithText(l);console.log("[ExamPaperViewer] Paper text extraction status:",t.text_extraction_status),console.log("[ExamPaperViewer] Paper extracted text length:",((p=t.paper_extracted_text)==null?void 0:p.length)||0),console.log("[ExamPaperViewer] Marking scheme extracted text length:",((x=t.marking_scheme_extracted_text)==null?void 0:x.length)||0);let n="",i="";t.text_extraction_status==="completed"?(t.paper_extracted_text&&(n=`
Exam Paper: ${t.title||"Untitled"}
Subject: ${(g=t.subject)==null?void 0:g.name}
Year: ${t.year}
Paper Number: ${t.paper_number}

=== EXAM PAPER CONTENT ===
${t.paper_extracted_text}
=== END OF EXAM PAPER ===

The student is asking about a specific question from this exam paper.
`),t.marking_scheme_extracted_text&&(i=`
=== MARKING SCHEME ===
${t.marking_scheme_extracted_text}
=== END OF MARKING SCHEME ===

Use this marking scheme to provide accurate guidance on how to get full marks.
`)):t.text_extraction_status==="processing"?(n=`
Exam Paper: ${t.title||"Untitled"}
Subject: ${(M=t.subject)==null?void 0:M.name}
Year: ${t.year}
Paper Number: ${t.paper_number}

Note: PDF text is currently being extracted. Please try again in a few moments for more detailed assistance.
`,i="PDF text extraction is in progress. Please wait and try again shortly."):t.text_extraction_status==="pending"?(n=`
Exam Paper: ${t.title||"Untitled"}
Subject: ${(k=t.subject)==null?void 0:k.name}
Year: ${t.year}
Paper Number: ${t.paper_number}

Note: PDF text extraction has not started yet. The AI will provide general guidance based on your question.
`,i="PDF text extraction is pending. General guidance will be provided."):(n=`
Exam Paper: ${t.title||"Untitled"}
Subject: ${(A=t.subject)==null?void 0:A.name}
Year: ${t.year}
Paper Number: ${t.paper_number}

Note: PDF text extraction failed. The AI will provide general educational guidance.
Error: ${t.extraction_error||"Unknown error"}
`,i="PDF text could not be extracted. Providing general educational guidance."),console.log("[ExamPaperViewer] Sending to AI - Paper content length:",n.length),console.log("[ExamPaperViewer] Sending to AI - Marking scheme content length:",i.length),(!n||n.length<100)&&console.warn("[ExamPaperViewer] WARNING: Paper content is empty or very short!"),(!i||i.length<100)&&console.warn("[ExamPaperViewer] WARNING: Marking scheme content is empty or very short!");const o=await c.sendChatMessage({paperId:l,question:s,paperContent:n,markingSchemeContent:i});return{userMessage:r,response:o}},onSuccess:async s=>{const{userMessage:r,response:t}=s,n=t.message;v(o=>{const p=new Set(o.map(g=>g.id)),x=[];return p.has(r.id)||x.push(r),p.has(n.id)||x.push(n),[...o,...x]});let i=$;if(!i&&l&&(i=(await c.createChatSession(l)).id,P(i)),i){const o=[...f,r,n];await c.updateChatSession(i,o)}},onError:s=>{let r="Unable to get a response from the AI tutor. Please try again.";s.status===503?r="AI service is currently unavailable. Please contact your administrator to configure the service.":s.status===429?r="AI service quota exceeded. Please try again later.":s.message&&(r=s.message),j(r)}}),D=s=>{s.preventDefault(),u.trim()&&!m.isPending&&(m.mutate(u),w(""))},R=s=>{try{return JSON.parse(s)}catch{return null}};return T?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(N,{className:"h-8 w-8 animate-spin text-emerald-600"})}):a?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>C("/app/exam-papers"),className:"inline-flex items-center text-sm text-gray-600 hover:text-gray-900",children:[e.jsx(H,{className:"h-4 w-4 mr-1"}),"Back to Papers"]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h1",{className:"text-xl font-bold text-gray-900",children:[(E=a.subject)==null?void 0:E.name," - Paper ",a.paper_number," (",a.year,")"]}),a.title&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:a.title})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 h-[calc(100vh-250px)]",children:[e.jsxs("div",{className:"bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center",children:[e.jsx(V,{className:"h-5 w-5 text-gray-600 mr-2"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Exam Paper"})]}),e.jsx("div",{className:"h-full overflow-auto p-4",children:y?e.jsx("iframe",{src:y,className:"w-full h-full border-0",title:"Exam Paper"}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(N,{className:"h-8 w-8 animate-spin text-gray-400"})})})]}),e.jsxs("div",{className:"bg-white shadow-sm rounded-lg border border-gray-200 flex flex-col",children:[e.jsxs("div",{className:"bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(S,{className:"h-5 w-5 text-gray-600 mr-2"}),e.jsx("span",{className:"font-medium text-gray-900",children:"AI Tutor"})]}),a&&e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[a.text_extraction_status==="completed"&&e.jsxs("span",{className:"flex items-center text-green-700",children:[e.jsx("svg",{className:"h-4 w-4 mr-1",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),"Content ready"]}),a.text_extraction_status==="processing"&&e.jsxs("span",{className:"flex items-center text-blue-700",children:[e.jsxs("svg",{className:"animate-spin h-4 w-4 mr-1",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Extracting content..."]}),(a.text_extraction_status==="pending"||a.text_extraction_status==="failed")&&e.jsxs("span",{className:"flex items-center text-amber-700",children:[e.jsx("svg",{className:"h-4 w-4 mr-1",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),"Limited content"]})]})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 space-y-4",children:[a&&(a.text_extraction_status==="pending"||a.text_extraction_status==="processing")&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(b,{className:"h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-blue-800 font-medium",children:a.text_extraction_status==="processing"?"PDF Content Extraction in Progress":"PDF Content Not Yet Extracted"}),e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:a.text_extraction_status==="processing"?"The exam paper and marking scheme are being processed. The AI can still help, but responses will be more accurate once extraction completes.":"The exam paper content has not been extracted yet. The AI will provide general guidance until the content is available."})]})]})}),a&&a.text_extraction_status==="failed"&&e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(b,{className:"h-5 w-5 text-amber-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-amber-800 font-medium",children:"Content Extraction Failed"}),e.jsx("p",{className:"text-sm text-amber-700 mt-1",children:"Unable to extract text from the PDF files. The AI will provide general educational guidance, but won't have access to the specific paper content."})]})]})}),_&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3",children:[e.jsx(b,{className:"h-5 w-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-red-800 font-medium",children:"Error"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:_})]}),e.jsx("button",{onClick:()=>j(null),className:"text-red-400 hover:text-red-600",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),f.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(S,{className:"h-12 w-12 mx-auto mb-3 text-gray-400"}),e.jsx("p",{className:"text-sm mb-2",children:"Ask the AI tutor about any question!"}),e.jsx("p",{className:"text-xs text-gray-400",children:'Example: "Explain question 5" or "How do I solve question 3?"'})]}):f.map(s=>{const r=s.role==="assistant"?R(s.content):null;return e.jsx("div",{className:`flex ${s.role==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[85%] rounded-lg px-4 py-3 ${s.role==="user"?"bg-emerald-600 text-white":"bg-gray-100 text-gray-900"}`,children:s.role==="user"?e.jsx("p",{className:"text-sm",children:s.content}):r?e.jsxs("div",{className:"space-y-3 text-sm",children:[r.explanation&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Explanation"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-wrap font-mono text-xs leading-relaxed",children:r.explanation})]}),r.examples&&r.examples.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Examples"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-gray-700",children:r.examples.map((t,n)=>e.jsx("li",{children:t},n))})]}),r.howToGetFullMarks&&r.howToGetFullMarks.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1",children:"How to Get Full Marks"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-gray-700",children:r.howToGetFullMarks.map((t,n)=>e.jsx("li",{children:t},n))})]}),r.solution&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Solution"}),e.jsx("div",{className:"text-gray-700 whitespace-pre-wrap font-mono text-xs leading-relaxed",children:r.solution})]})]}):e.jsx("p",{className:"text-sm",children:s.content})})},s.id)}),m.isPending&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-gray-100 rounded-lg px-4 py-3",children:e.jsx(N,{className:"h-5 w-5 animate-spin text-gray-600"})})})]}),e.jsx("div",{className:"border-t border-gray-200 p-4",children:e.jsxs("form",{onSubmit:D,className:"flex gap-2",children:[e.jsx("input",{type:"text",value:u,onChange:s=>w(s.target.value),placeholder:"Ask about a specific question...",className:"flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500",disabled:m.isPending}),e.jsx("button",{type:"submit",disabled:!u.trim()||m.isPending,className:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(z,{className:"h-4 w-4"})})]})})]})]})]}):e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-gray-600",children:"Exam paper not found"})})}export{X as ExamPaperViewer};
